<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Solana Multisig Decoder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #111826;
        --muted: #8b9bb4;
        --text: #e6edf3;
        --primary: #4f8cff;
        --accent: #23d5ab;
        --danger: #ff6b6b;
        --border: #1c2838;
        --code: #0f1622;
        --code-border: #1b2a3f;
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: radial-gradient(1200px 600px at 80% -10%, rgba(79, 140, 255, 0.15), transparent 60%),
                    radial-gradient(1000px 500px at -10% 30%, rgba(35, 213, 171, 0.12), transparent 60%),
                    var(--bg);
        color: var(--text);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .container {
        max-width: 980px;
        margin: 40px auto;
        padding: 0 20px 80px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 24px;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 600;
      }
      .title .pill {
        padding: 4px 8px;
        background: rgba(79, 140, 255, 0.1);
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 11px;
        color: var(--primary);
      }
      .panel {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent), var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03);
      }
      .input-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        padding: 16px;
      }
      .input {
        display: flex;
        gap: 10px;
        background: rgba(0,0,0,0.25);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
      }
      input[type="text"] {
        flex: 1;
        background: transparent;
        color: var(--text);
        border: none;
        font-size: 14px;
        outline: none;
      }
      .btn {
        appearance: none;
        padding: 10px 16px;
        background: linear-gradient(180deg, rgba(255,255,255,0.08), transparent), var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.08s ease, filter 0.2s ease;
      }
      .btn:hover { filter: brightness(1.05); }
      .btn:active { transform: translateY(1px); }
      .meta {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        color: var(--muted);
        font-size: 12px;
      }
      .grid {
        display: grid;
        gap: 12px;
        padding: 16px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
      }
      .row {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 12px;
        padding: 6px 0;
        border-bottom: 1px dashed var(--border);
      }
      .row:last-child { border-bottom: 0; }
      .key { color: var(--muted); }
      .val { word-break: break-all; }

      .code {
        background: var(--code);
        border: 1px solid var(--code-border);
        border-radius: 10px;
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        overflow: auto;
        max-height: 400px;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 11px;
        color: var(--muted);
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--border);
        border-radius: 999px;
      }
      .token {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        font-size: 12px;
        color: var(--muted);
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--border);
        border-radius: 999px;
        transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
      }
      .token:hover { color: var(--text); border-color: #2a3a52; background: rgba(255,255,255,0.06); }
      .val a, .badge a, .token a { color: inherit; text-decoration: none; border-bottom: 1px dotted transparent; }
      .val a:hover, .badge a:hover, .token a:hover { border-bottom-color: var(--primary); }
      .error {
        color: var(--danger);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="title">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 17h12M6 12h12M6 7h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <span>Solana Multisig Decoder</span>
          <span class="pill">Squads + Anchor</span>
        </div>
      </div>

      <div class="panel">
        <div class="input-row">
          <div class="input" style="grid-column: 1 / span 1;">
            <input id="txId" type="text" placeholder="Enter TX hash (Squads Transaction ID) e.g. BtVmmpGqhvXgonCWU2DUb3mvyzDErFSi5MhZM8Qw5ium" />
          </div>
          <button id="decodeBtn" class="btn">Decode</button>
        </div>
        <div class="meta" id="status">Idle</div>
      </div>

      <div class="grid" id="results" style="display:none">
        <div class="card">
          <div class="row"><div class="key">Transaction ID</div><div class="val" id="outTxId"></div></div>
          <div class="row"><div class="key">Memo</div><div class="val" id="outMemo"></div></div>
          <div class="row"><div class="key">Instructions</div><div class="val"><span class="badge" id="outInstrCount"></span></div></div>
        </div>

        <div id="instrContainer" class="grid"></div>
      </div>
    </div>

    <script>
      const txInput = document.getElementById('txId');
      const decodeBtn = document.getElementById('decodeBtn');
      const statusEl = document.getElementById('status');
      const results = document.getElementById('results');
      const outTxId = document.getElementById('outTxId');
      const outMemo = document.getElementById('outMemo');
      const outInstrCount = document.getElementById('outInstrCount');
      const instrContainer = document.getElementById('instrContainer');

      function setStatus(text, isError = false) {
        statusEl.textContent = text;
        statusEl.classList.toggle('error', isError);
      }

      function isBase58Address(str) {
        if (typeof str !== 'string') return false;
        if (str.length < 32 || str.length > 44) return false;
        return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(str);
      }

      function truncateMiddle(str, left = 6, right = 6) {
        if (typeof str !== 'string') return str;
        if (str.length <= left + right + 3) return str;
        return `${str.slice(0, left)}â€¦${str.slice(-right)}`;
      }

      function linkToSolscanAccount(address) {
        const href = `https://solscan.io/account/${encodeURIComponent(address)}`;
        return `<span class=\"token\"><a class=\"address-link\" href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\">${truncateMiddle(address)}</a></span>`;
      }

      function linkToSolscanTx(sig) {
        const href = `https://solscan.io/tx/${encodeURIComponent(sig)}`;
        return `<span class=\"token\"><a class=\"address-link\" href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\">${truncateMiddle(sig)}</a></span>`;
      }

      function collectAddresses(obj, out = new Set()) {
        if (obj === null || obj === undefined) return out;
        if (typeof obj === 'string' && isBase58Address(obj)) { out.add(obj); return out; }
        if (Array.isArray(obj)) { obj.forEach(v => collectAddresses(v, out)); return out; }
        if (typeof obj === 'object') { Object.values(obj).forEach(v => collectAddresses(v, out)); return out; }
        return out;
      }

      function renderInstructionCard(instr, idx) {
        const card = document.createElement('div');
        card.className = 'card';
        const accountsHtml = instr.accounts.map(acc => `
          <div class=\"row\"><div class=\"key\">${acc.name}</div><div class=\"val\">${linkToSolscanAccount(acc.address)}</div></div>
        `).join('');
        const detected = Array.from(collectAddresses(instr.decodedData)).filter(a => !instr.accounts?.some(ac => ac.address === a));
        const detectedHtml = detected.length ? `
          <div class=\"row\"><div class=\"key\">Detected Addresses</div><div class=\"val\">
            ${detected.map(a => `${linkToSolscanAccount(a)}`).join(' ')}
          </div></div>
        ` : '';
        card.innerHTML = `
          <div class=\"row\"><div class=\"key\">#</div><div class=\"val\">${idx + 1}</div></div>
          <div class=\"row\"><div class=\"key\">Program</div><div class=\"val\">${instr.programName} ${linkToSolscanAccount(instr.programId)}</div></div>
          <div class=\"row\"><div class=\"key\">Instruction</div><div class=\"val\">${instr.instructionName}</div></div>
          <div class=\"row\"><div class=\"key\">Accounts</div><div class=\"val\"></div></div>
          ${accountsHtml}
          ${detectedHtml}
          <div style=\"height:8px\"></div>
          <div class=\"code\">${escapeHtml(JSON.stringify(instr.decodedData, null, 2))}</div>
        `;
        return card;
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      async function decode() {
        const txId = txInput.value.trim();
        if (!txId) {
          setStatus('Please enter a TX hash', true);
          return;
        }
        setStatus('Decoding...');
        results.style.display = 'none';
        instrContainer.innerHTML = '';
        try {
          const res = await fetch(`/api/decode/${encodeURIComponent(txId)}`);
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Failed');
          outTxId.innerHTML = data.transactionId ? linkToSolscanTx(data.transactionId) : '';
          outMemo.textContent = data.memo || '';
          outInstrCount.textContent = (data.instructions || []).length;
          (data.instructions || []).forEach((instr, idx) => {
            instrContainer.appendChild(renderInstructionCard(instr, idx));
          });
          results.style.display = '';
          setStatus('Done');
        } catch (e) {
          setStatus(e.message || String(e), true);
        }
      }

      decodeBtn.addEventListener('click', decode);
      txInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') decode();
      });
    </script>
  </body>
  </html>


